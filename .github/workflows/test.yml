name: ðŸ§ª Tests & Security

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œå›žå½’æµ‹è¯•å’Œå®‰å…¨å®¡è®¡
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '9.0.0'

jobs:
  # å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
  test:
    name: ðŸ”¬ Unit & Integration Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ matrix.node-version }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: ðŸ” Type check
        run: pnpm type-check

      - name: ðŸ§¹ Lint check
        run: pnpm lint:check

      - name: ðŸ’… Format check
        run: pnpm format:check

      - name: ðŸ§ª Run unit tests
        run: pnpm test:coverage
        continue-on-error: true

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ðŸ“ˆ Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ matrix.node-version }}
          path: coverage/

  # æž„å»ºæµ‹è¯•
  build:
    name: ðŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: ðŸ—ï¸ Build project
        uses: ./.github/actions/build-project

      - name: ðŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: apps/frontend/dist/
          if-no-files-found: error
          retention-days: 1

  # æ€§èƒ½æµ‹è¯•
  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: build
    if: success()

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: dist/

      - name: âš¡ Run performance benchmarks
        run: pnpm perf:benchmark
        continue-on-error: true

      - name: ðŸ“Š Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: performance-results.json

  # å®‰å…¨æ‰«æï¼ˆåˆå¹¶äº†åŽŸ audit-fix.yml çš„åŠŸèƒ½ï¼‰
  security:
    name: ðŸ”’ Security Scan & Audit
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: ðŸ” Run security audit
        uses: ./.github/actions/security-audit

      - name: ðŸ”’ Run CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: ðŸ”’ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  # ä¾èµ–æ£€æŸ¥
  dependency-check:
    name: ðŸ“¦ Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: ðŸ” Check for outdated dependencies
        run: pnpm outdated || true

      - name: ðŸ“Š Generate dependency report
        run: |
          pnpm list --depth=0 --json > dependency-report.json
          echo "## ðŸ“¦ Dependencies Report" >> $GITHUB_STEP_SUMMARY
          echo "Generated dependency report with $(jq '.dependencies | length' dependency-report.json) direct dependencies" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¦ Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependency-report.json

  # ç®€åŒ–çš„æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
  test-summary:
    name: ðŸ“‹ Test Summary
    runs-on: ubuntu-latest
    needs: [test, build, performance, security, dependency-check]
    if: always()

    steps:
      - name: ðŸ“Š Generate test summary
        run: |
          echo "# ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Test Matrix Results" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Test: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance: ${{ needs.performance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependencies: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY

          # ç®€å•çš„æˆåŠŸ/å¤±è´¥åˆ¤æ–­
          if [[ "${{ needs.test.result }}" == "success" && "${{ needs.build.result }}" == "success" && "${{ needs.security.result }}" == "success" ]]; then
            echo "âœ… All critical tests passed - Ready for deployment ðŸš€" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some tests failed - Please check and fix issues" >> $GITHUB_STEP_SUMMARY
          fi
