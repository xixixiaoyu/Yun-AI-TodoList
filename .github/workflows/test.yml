name: ğŸ§ª Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œå›å½’æµ‹è¯•
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
  test:
    name: ğŸ”¬ Unit & Integration Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Type check
        run: pnpm run type-check

      - name: ğŸ§¹ Lint check
        run: pnpm run lint:check

      - name: ğŸ’… Format check
        run: pnpm run format:check

      - name: ğŸ§ª Run unit tests
        run: pnpm run test:coverage
        continue-on-error: true

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ğŸ“ˆ Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ matrix.node-version }}
          path: coverage/

  # æ„å»ºæµ‹è¯•
  build:
    name: ğŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build application
        run: pnpm run build

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: dist/

  # æ€§èƒ½æµ‹è¯•
  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: dist/

      - name: âš¡ Run performance benchmarks
        run: pnpm run perf:benchmark
        continue-on-error: true

      - name: ğŸ“Š Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: performance-results.json

  # å®‰å…¨æ‰«æ
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Run security audit
        run: pnpm audit --audit-level moderate

      - name: ğŸ”’ Run CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: ğŸ”’ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  # ä¾èµ–æ£€æŸ¥
  dependency-check:
    name: ğŸ“¦ Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Check for outdated dependencies
        run: pnpm outdated || true

      - name: ğŸ“Š Generate dependency report
        run: |
          pnpm list --depth=0 --json > dependency-report.json
          echo "## ğŸ“¦ Dependencies Report" >> $GITHUB_STEP_SUMMARY
          echo "Generated dependency report with $(jq '.dependencies | length' dependency-report.json) direct dependencies" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¦ Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependency-report.json

  # æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
  test-summary:
    name: ğŸ“‹ Test Summary
    runs-on: ubuntu-latest
    needs: [test, build, performance, security, dependency-check]
    if: always()

    steps:
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4

      - name: ğŸ“Š Generate test summary
        run: |
          echo "# ğŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "coverage-reports-18" ]; then
            echo "## ğŸ“ˆ Coverage Report (Node 18)" >> $GITHUB_STEP_SUMMARY
            echo "Coverage reports generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "build-files/index.html" ]; then
            echo "## âœ… Build Status" >> $GITHUB_STEP_SUMMARY
            echo "Application built successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "performance-results.json" ]; then
            echo "## âš¡ Performance Results" >> $GITHUB_STEP_SUMMARY
            echo "Performance benchmarks completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "## ğŸ¯ Test Matrix Results" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Test: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance: ${{ needs.performance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependencies: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY

  # é€šçŸ¥
  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [test-summary]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¢ Notify on success
        if: needs.test-summary.result == 'success'
        run: |
          echo "âœ… All tests passed successfully!"
          echo "Ready for deployment ğŸš€"

      - name: ğŸ“¢ Notify on failure
        if: needs.test-summary.result == 'failure'
        run: |
          echo "âŒ Some tests failed!"
          echo "Please check the test results and fix issues before merging."
          exit 1
