name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read
  pages: write
  id-token: write

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '9.0.0'

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šæµ‹è¯•å’Œæž„å»º
  test-and-build:
    name: ðŸ§ª Test & Build
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.artifact.outputs.name }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: ðŸ” Type check
        run: pnpm type-check

      - name: ðŸ§¹ Lint check
        run: pnpm lint:check

      - name: ðŸ’… Format check
        run: pnpm format:check

      - name: ðŸ§ª Run unit tests
        run: pnpm test:coverage
        continue-on-error: true

      - name: ðŸ” Run security audit
        uses: ./.github/actions/security-audit

      - name: ðŸ—ï¸ Build project
        uses: ./.github/actions/build-project

      - name: ðŸ“¦ Upload build artifacts
        id: artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-files-${{ github.sha }}
          path: apps/frontend/dist/
          if-no-files-found: error
          retention-days: 7

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ç¬¬äºŒé˜¶æ®µï¼šéƒ¨ç½²ï¼ˆæš‚æ—¶å†…è”ï¼Œé¿å…å¯é‡ç”¨å·¥ä½œæµçš„è¯­æ³•é—®é¢˜ï¼‰
  deploy-github-pages:
    name: ðŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: test-and-build
    if: success() && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files-${{ github.sha }}
          path: ./dist

      - name: ðŸ“„ Setup Pages
        uses: actions/configure-pages@v4

      - name: ðŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-qiniu:
    name: ðŸš€ Deploy to Qiniu Cloud
    runs-on: ubuntu-latest
    needs: test-and-build
    if: success() && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code (for deploy script)
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files-${{ github.sha }}
          path: ./apps/frontend/dist

      - name: ðŸš€ Deploy to Qiniu using S3 API
        timeout-minutes: 30  # å¢žåŠ æ­¥éª¤è¶…æ—¶æ—¶é—´ä¸º 30 åˆ†é’Ÿï¼Œä»¥é€‚åº”å¤§æ–‡ä»¶ä¸Šä¼ 
        run: |
          echo "ðŸš€ Deploying to Qiniu Cloud..."
          echo "ðŸ“‹ Files to upload: $(find apps/frontend/dist -type f | wc -l)"
          node scripts/deploy-qiniu-s3.cjs
        env:
          QINIU_ACCESS_KEY: ${{ secrets.QINIU_ACCESS_KEY }}
          QINIU_SECRET_KEY: ${{ secrets.QINIU_SECRET_KEY }}
          QINIU_BUCKET: ${{ secrets.QINIU_BUCKET }}
          QINIU_REGION: ${{ secrets.QINIU_REGION }}
          QINIU_ENDPOINT: ${{ secrets.QINIU_ENDPOINT }}
          QINIU_DOMAIN: ${{ secrets.QINIU_DOMAIN }}

  # ç¬¬ä¸‰é˜¶æ®µï¼šéƒ¨ç½²åŽéªŒè¯å’Œé€šçŸ¥
  post-deploy:
    name: ðŸ“‹ Post-Deploy Summary
    runs-on: ubuntu-latest
    needs: [test-and-build, deploy-github-pages, deploy-qiniu]
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“Š Generate deployment summary
        run: |
          echo "# ðŸŽ‰ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Test & Build**: ${{ needs.test-and-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Pages**: ${{ needs.deploy-github-pages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Qiniu Cloud**: ${{ needs.deploy-qiniu.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.test-and-build.result }}" == "success" ]]; then
            echo "âœ… **Status**: Pipeline completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Deployments**: Both targets deployed in parallel" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Pipeline failed during test/build phase" >> $GITHUB_STEP_SUMMARY
          fi
