name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read
  pages: write
  id-token: write

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '9.0.0'

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šæµ‹è¯•å’Œæž„å»º
  test-and-build:
    name: ðŸ§ª Test & Build
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.artifact.outputs.name }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: ðŸ” Type check
        run: pnpm type-check

      - name: ðŸ§¹ Lint check
        run: pnpm lint:check

      - name: ðŸ’… Format check
        run: pnpm format:check

      - name: ðŸ§ª Run unit tests
        run: pnpm test:coverage
        continue-on-error: true

      - name: ðŸ” Run security audit
        uses: ./.github/actions/security-audit

      - name: ðŸ—ï¸ Build project
        uses: ./.github/actions/build-project

      - name: ðŸ“¦ Upload build artifacts
        id: artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-files-${{ github.sha }}
          path: apps/frontend/dist/
          if-no-files-found: error
          retention-days: 7

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ç¬¬äºŒé˜¶æ®µï¼šå¹¶è¡Œéƒ¨ç½²
  deploy-github-pages:
    name: ðŸš€ Deploy to GitHub Pages
    needs: test-and-build
    if: success() && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/deploy-github-pages.yml
    with:
      artifact-name: build-files-${{ github.sha }}
      environment: github-pages

  deploy-qiniu:
    name: ðŸš€ Deploy to Qiniu Cloud
    needs: test-and-build
    if: success() && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/deploy-qiniu-reusable.yml
    with:
      artifact-name: build-files-${{ github.sha }}
    secrets:
      QINIU_ACCESS_KEY: ${{ secrets.QINIU_ACCESS_KEY }}
      QINIU_SECRET_KEY: ${{ secrets.QINIU_SECRET_KEY }}
      QINIU_BUCKET: ${{ secrets.QINIU_BUCKET }}
      QINIU_REGION: ${{ secrets.QINIU_REGION }}
      QINIU_ENDPOINT: ${{ secrets.QINIU_ENDPOINT }}
      QINIU_DOMAIN: ${{ secrets.QINIU_DOMAIN }}

  # ç¬¬ä¸‰é˜¶æ®µï¼šéƒ¨ç½²åŽéªŒè¯å’Œé€šçŸ¥
  post-deploy:
    name: ðŸ“‹ Post-Deploy Summary
    runs-on: ubuntu-latest
    needs: [test-and-build, deploy-github-pages, deploy-qiniu]
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“Š Generate deployment summary
        run: |
          echo "# ðŸŽ‰ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Test & Build**: ${{ needs.test-and-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Pages**: ${{ needs.deploy-github-pages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Qiniu Cloud**: ${{ needs.deploy-qiniu.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.test-and-build.result }}" == "success" ]]; then
            echo "âœ… **Status**: Pipeline completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Deployments**: Both targets deployed in parallel" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Pipeline failed during test/build phase" >> $GITHUB_STEP_SUMMARY
          fi
