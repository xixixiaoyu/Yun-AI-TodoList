#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# 检查是否是推送到远程仓库后的提交
# 只有在推送到 main 或 develop 分支时才自动部署
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "develop" ]; then
    echo "🚀 检测到推送到 $CURRENT_BRANCH 分支，开始自动部署到 Cloudflare..."
    
    # 检查是否有 wrangler 命令
    if ! command -v wrangler &> /dev/null; then
        echo "⚠️  Wrangler CLI 未安装，跳过自动部署"
        echo "💡 安装方法: npm install -g wrangler"
        exit 0
    fi
    
    # 构建前端项目
    echo "🏗️  构建前端项目..."
    pnpm --filter shared build
    pnpm --filter frontend build
    
    # 根据分支选择部署环境
    if [ "$CURRENT_BRANCH" = "main" ]; then
        echo "📦 部署到生产环境..."
        pnpm wrangler deploy --env production
    else
        echo "📦 部署到开发环境..."
        pnpm wrangler deploy --env development
    fi
    
    echo "✅ Cloudflare 部署完成！"
else
    echo "ℹ️  当前分支 ($CURRENT_BRANCH) 不需要自动部署"
fi