#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# æ£€æŸ¥æ˜¯å¦æ˜¯æ¨é€åˆ°è¿œç¨‹ä»“åº“åçš„æäº¤
# åªæœ‰åœ¨æ¨é€åˆ° main æˆ– develop åˆ†æ”¯æ—¶æ‰è‡ªåŠ¨éƒ¨ç½²
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "develop" ]; then
    echo "ğŸš€ æ£€æµ‹åˆ°æ¨é€åˆ° $CURRENT_BRANCH åˆ†æ”¯ï¼Œå¼€å§‹è‡ªåŠ¨éƒ¨ç½²åˆ° Cloudflare..."
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ wrangler å‘½ä»¤
    if ! command -v wrangler &> /dev/null; then
        echo "âš ï¸  Wrangler CLI æœªå®‰è£…ï¼Œè·³è¿‡è‡ªåŠ¨éƒ¨ç½²"
        echo "ğŸ’¡ å®‰è£…æ–¹æ³•: npm install -g wrangler"
        exit 0
    fi
    
    # æ„å»ºå‰ç«¯é¡¹ç›®
    echo "ğŸ—ï¸  æ„å»ºå‰ç«¯é¡¹ç›®..."
    pnpm --filter shared build
    pnpm --filter frontend build
    
    # æ ¹æ®åˆ†æ”¯é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ
    if [ "$CURRENT_BRANCH" = "main" ]; then
        echo "ğŸ“¦ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
        pnpm wrangler deploy --env production
    else
        echo "ğŸ“¦ éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
        pnpm wrangler deploy --env development
    fi
    
    echo "âœ… Cloudflare éƒ¨ç½²å®Œæˆï¼"
else
    echo "â„¹ï¸  å½“å‰åˆ†æ”¯ ($CURRENT_BRANCH) ä¸éœ€è¦è‡ªåŠ¨éƒ¨ç½²"
fi